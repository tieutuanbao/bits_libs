#include "fft.h"

/**
    *    @brief: Bảng tham chiếu dịch sin cos
    */
#if (FFT_N_SAMPLE == 512)
const int16_t cos_sin_table[320]= {10000, 9997, 9988, 9973, 9952, 9925, 9892, 9853, 9808, 9757, 9700, 9638, 9569, 9495, 9415, 9330, 9239, 9142, 9040, 8932, 8819, 8701, 8577, 8449, 8315, 8176, 8032, 7883, 7730, 7572, 7410, 7242, 7071, 6895, 6716, 6532, 6344, 6152, 5957, 5758, 5556, 5350, 5141, 4929, 4714, 4496, 4276, 4052, 3827, 3599, 3369, 3137, 2903, 2667, 2430, 2191, 1951, 1710, 1467, 1224, 980, 736, 491, 245, 0, -245, -491, -736, -980, -1224, -1467, -1710, -1951, -2191, -2430, -2667, -2903, -3137, -3369, -3599, -3827, -4052, -4276, -4496, -4714, -4929, -5141, -5350, -5556, -5758, -5957, -6152, -6344, -6532, -6716, -6895, -7071, -7242, -7410, -7572, -7730, -7883, -8032, -8176, -8315, -8449, -8577, -8701, -8819, -8932, -9040, -9142, -9239, -9330, -9415, -9495, -9569, -9638, -9700, -9757, -9808, -9853, -9892, -9925, -9952, -9973, -9988, -9997, -10000, -9997, -9988, -9973, -9952, -9925, -9892, -9853, -9808, -9757, -9700, -9638, -9569, -9495, -9415, -9330, -9239, -9142, -9040, -8932, -8819, -8701, -8577, -8449, -8315, -8176, -8032, -7883, -7730, -7572, -7410, -7242, -7071, -6895, -6716, -6532, -6344, -6152, -5957, -5758, -5556, -5350, -5141, -4929, -4714, -4496, -4276, -4052, -3827, -3599, -3369, -3137, -2903, -2667, -2430, -2191, -1951, -1710, -1467, -1224, -980, -736, -491, -245, -0, 245, 491, 736, 980, 1224, 1467, 1710, 1951, 2191, 2430, 2667, 2903, 3137, 3369, 3599, 3827, 4052, 4276, 4496, 4714, 4929, 5141, 5350, 5556, 5758, 5957, 6152, 6344, 6532, 6716, 6895, 7071, 7242, 7410, 7572, 7730, 7883, 8032, 8176, 8315, 8449, 8577, 8701, 8819, 8932, 9040, 9142, 9239, 9330, 9415, 9495, 9569, 9638, 9700, 9757, 9808, 9853, 9892, 9925, 9952, 9973, 9988, 9997, 10000, 9997, 9988, 9973, 9952, 9925, 9892, 9853, 9808, 9757, 9700, 9638, 9569, 9495, 9415, 9330, 9239, 9142, 9040, 8932, 8819, 8701, 8577, 8449, 8315, 8176, 8032, 7883, 7730, 7572, 7410, 7242, 7071, 6895, 6716, 6532, 6344, 6152, 5957, 5758, 5556, 5350, 5141, 4929, 4714, 4496, 4276, 4052, 3827, 3599, 3369, 3137, 2903, 2667, 2430, 2191, 1951, 1710, 1467, 1224, 980, 736, 491, 245};
#elif (FFT_N_SAMPLE == 1024)
const int16_t cos_sin_table[640]= {10000, 9999, 9997, 9993, 9988, 9981, 9973, 9963, 9952, 9939, 9925, 9909, 9892, 9873, 9853, 9831, 9808, 9783, 9757, 9729, 9700, 9670, 9638, 9604, 9569, 9533, 9495, 9456, 9415, 9373, 9330, 9285, 9239, 9191, 9142, 9092, 9040, 8987, 8932, 8876, 8819, 8761, 8701, 8640, 8577, 8514, 8449, 8382, 8315, 8246, 8176, 8105, 8032, 7958, 7883, 7807, 7730, 7652, 7572, 7491, 7410, 7327, 7242, 7157, 7071, 6984, 6895, 6806, 6716, 6624, 6532, 6438, 6344, 6249, 6152, 6055, 5957, 5858, 5758, 5657, 5556, 5453, 5350, 5246, 5141, 5035, 4929, 4822, 4714, 4605, 4496, 4386, 4276, 4164, 4052, 3940, 3827, 3713, 3599, 3484, 3369, 3253, 3137, 3020, 2903, 2785, 2667, 2549, 2430, 2311, 2191, 2071, 1951, 1830, 1710, 1589, 1467, 1346, 1224, 1102, 980, 858, 736, 613, 491, 368, 245, 123, 0, -123, -245, -368, -491, -613, -736, -858, -980, -1102, -1224, -1346, -1467, -1589, -1710, -1830, -1951, -2071, -2191, -2311, -2430, -2549, -2667, -2785, -2903, -3020, -3137, -3253, -3369, -3484, -3599, -3713, -3827, -3940, -4052, -4164, -4276, -4386, -4496, -4605, -4714, -4822, -4929, -5035, -5141, -5246, -5350, -5453, -5556, -5657, -5758, -5858, -5957, -6055, -6152, -6249, -6344, -6438, -6532, -6624, -6716, -6806, -6895, -6984, -7071, -7157, -7242, -7327, -7410, -7491, -7572, -7652, -7730, -7807, -7883, -7958, -8032, -8105, -8176, -8246, -8315, -8382, -8449, -8514, -8577, -8640, -8701, -8761, -8819, -8876, -8932, -8987, -9040, -9092, -9142, -9191, -9239, -9285, -9330, -9373, -9415, -9456, -9495, -9533, -9569, -9604, -9638, -9670, -9700, -9729, -9757, -9783, -9808, -9831, -9853, -9873, -9892, -9909, -9925, -9939, -9952, -9963, -9973, -9981, -9988, -9993, -9997, -9999, -10000, -9999, -9997, -9993, -9988, -9981, -9973, -9963, -9952, -9939, -9925, -9909, -9892, -9873, -9853, -9831, -9808, -9783, -9757, -9729, -9700, -9670, -9638, -9604, -9569, -9533, -9495, -9456, -9415, -9373, -9330, -9285, -9239, -9191, -9142, -9092, -9040, -8987, -8932, -8876, -8819, -8761, -8701, -8640, -8577, -8514, -8449, -8382, -8315, -8246, -8176, -8105, -8032, -7958, -7883, -7807, -7730, -7652, -7572, -7491, -7410, -7327, -7242, -7157, -7071, -6984, -6895, -6806, -6716, -6624, -6532, -6438, -6344, -6249, -6152, -6055, -5957, -5858, -5758, -5657, -5556, -5453, -5350, -5246, -5141, -5035, -4929, -4822, -4714, -4605, -4496, -4386, -4276, -4164, -4052, -3940, -3827, -3713, -3599, -3484, -3369, -3253, -3137, -3020, -2903, -2785, -2667, -2549, -2430, -2311, -2191, -2071, -1951, -1830, -1710, -1589, -1467, -1346, -1224, -1102, -980, -858, -736, -613, -491, -368, -245, -123, -0, 123, 245, 368, 491, 613, 736, 858, 980, 1102, 1224, 1346, 1467, 1589, 1710, 1830, 1951, 2071, 2191, 2311, 2430, 2549, 2667, 2785, 2903, 3020, 3137, 3253, 3369, 3484, 3599, 3713, 3827, 3940, 4052, 4164, 4276, 4386, 4496, 4605, 4714, 4822, 4929, 5035, 5141, 5246, 5350, 5453, 5556, 5657, 5758, 5858, 5957, 6055, 6152, 6249, 6344, 6438, 6532, 6624, 6716, 6806, 6895, 6984, 7071, 7157, 7242, 7327, 7410, 7491, 7572, 7652, 7730, 7807, 7883, 7958, 8032, 8105, 8176, 8246, 8315, 8382, 8449, 8514, 8577, 8640, 8701, 8761, 8819, 8876, 8932, 8987, 9040, 9092, 9142, 9191, 9239, 9285, 9330, 9373, 9415, 9456, 9495, 9533, 9569, 9604, 9638, 9670, 9700, 9729, 9757, 9783, 9808, 9831, 9853, 9873, 9892, 9909, 9925, 9939, 9952, 9963, 9973, 9981, 9988, 9993, 9997, 9999, 10000, 9999, 9997, 9993, 9988, 9981, 9973, 9963, 9952, 9939, 9925, 9909, 9892, 9873, 9853, 9831, 9808, 9783, 9757, 9729, 9700, 9670, 9638, 9604, 9569, 9533, 9495, 9456, 9415, 9373, 9330, 9285, 9239, 9191, 9142, 9092, 9040, 8987, 8932, 8876, 8819, 8761, 8701, 8640, 8577, 8514, 8449, 8382, 8315, 8246, 8176, 8105, 8032, 7958, 7883, 7807, 7730, 7652, 7572, 7491, 7410, 7327, 7242, 7157, 7071, 6984, 6895, 6806, 6716, 6624, 6532, 6438, 6344, 6249, 6152, 6055, 5957, 5858, 5758, 5657, 5556, 5453, 5350, 5246, 5141, 5035, 4929, 4822, 4714, 4605, 4496, 4386, 4276, 4164, 4052, 3940, 3827, 3713, 3599, 3484, 3369, 3253, 3137, 3020, 2903, 2785, 2667, 2549, 2430, 2311, 2191, 2071, 1951, 1830, 1710, 1589, 1467, 1346, 1224, 1102, 980, 858, 736, 613, 491, 368, 245, 123
};
#endif

/**
    *    @brief: Bảng hamming window 512 điểm
    */
#if (FFT_N_SAMPLE == 512)
const uint16_t hamming_window_table[]= {80, 80, 80, 80, 81, 81, 81, 82, 82, 83, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 94, 95, 97, 98, 100, 101, 103, 105, 107, 109, 111, 113, 115, 117, 119, 122, 124, 127, 129, 132, 134, 137, 140, 143, 145, 148, 151, 154, 158, 161, 164, 167, 171, 174, 177, 181, 184, 188, 192, 195, 199, 203, 207, 211, 215, 219, 223, 227, 231, 235, 240, 244, 248, 253, 257, 261, 266, 271, 275, 280, 284, 289, 294, 299, 304, 308, 313, 318, 323, 328, 333, 338, 343, 348, 354, 359, 364, 369, 374, 380, 385, 390, 396, 401, 406, 412, 417, 423, 428, 434, 439, 445, 450, 456, 461, 467, 473, 478, 484, 489, 495, 501, 506, 512, 517, 523, 529, 534, 540, 546, 551, 557, 563, 568, 574, 579, 585, 591, 596, 602, 607, 613, 619, 624, 630, 635, 641, 646, 652, 657, 663, 668, 674, 679, 684, 690, 695, 700, 706, 711, 716, 721, 726, 732, 737, 742, 747, 752, 757, 762, 767, 772, 776, 781, 786, 791, 796, 800, 805, 809, 814, 819, 823, 827, 832, 836, 840, 845, 849, 853, 857, 861, 865, 869, 873, 877, 881, 885, 888, 892, 896, 899, 903, 906, 909, 913, 916, 919, 922, 926, 929, 932, 935, 937, 940, 943, 946, 948, 951, 953, 956, 958, 961, 963, 965, 967, 969, 971, 973, 975, 977, 979, 980, 982, 983, 985, 986, 988, 989, 990, 991, 992, 993, 994, 995, 996, 997, 997, 998, 998, 999, 999, 999, 1000, 1000, 1000};
#elif (FFT_N_SAMPLE == 1024)
const uint16_t hamming_window_table[]= {80, 80, 80, 80, 80, 80, 80, 80, 81, 81, 81, 81, 81, 81, 82, 82, 82, 83, 83, 83, 83, 84, 84, 85, 85, 85, 86, 86, 87, 87, 88, 88, 89, 89, 90, 91, 91, 92, 92, 93, 94, 94, 95, 96, 97, 97, 98, 99, 100, 101, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 121, 122, 123, 124, 125, 127, 128, 129, 130, 132, 133, 134, 136, 137, 138, 140, 141, 143, 144, 145, 147, 148, 150, 151, 153, 154, 156, 158, 159, 161, 162, 164, 166, 167, 169, 171, 172, 174, 176, 177, 179, 181, 183, 184, 186, 188, 190, 192, 194, 195, 197, 199, 201, 203, 205, 207, 209, 211, 213, 215, 217, 219, 221, 223, 225, 227, 229, 231, 233, 235, 237, 240, 242, 244, 246, 248, 250, 253, 255, 257, 259, 261, 264, 266, 268, 271, 273, 275, 277, 280, 282, 284, 287, 289, 292, 294, 296, 299, 301, 304, 306, 308, 311, 313, 316, 318, 321, 323, 326, 328, 331, 333, 336, 338, 341, 343, 346, 348, 351, 354, 356, 359, 361, 364, 367, 369, 372, 374, 377, 380, 382, 385, 388, 390, 393, 396, 398, 401, 404, 406, 409, 412, 415, 417, 420, 423, 425, 428, 431, 434, 436, 439, 442, 445, 447, 450, 453, 456, 459, 461, 464, 467, 470, 473, 475, 478, 481, 484, 486, 489, 492, 495, 498, 501, 503, 506, 509, 512, 515, 517, 520, 523, 526, 529, 532, 534, 537, 540, 543, 546, 548, 551, 554, 557, 560, 563, 565, 568, 571, 574, 577, 579, 582, 585, 588, 591, 594, 596, 599, 602, 605, 607, 610, 613, 616, 619, 621, 624, 627, 630, 633, 635, 638, 641, 644, 646, 649, 652, 655, 657, 660, 663, 665, 668, 671, 674, 676, 679, 682, 684, 687, 690, 692, 695, 698, 700, 703, 706, 708, 711, 713, 716, 719, 721, 724, 726, 729, 732, 734, 737, 739, 742, 744, 747, 749, 752, 754, 757, 759, 762, 764, 767, 769, 772, 774, 776, 779, 781, 784, 786, 788, 791, 793, 796, 798, 800, 803, 805, 807, 809, 812, 814, 816, 819, 821, 823, 825, 827, 830, 832, 834, 836, 838, 840, 843, 845, 847, 849, 851, 853, 855, 857, 859, 861, 863, 865, 867, 869, 871, 873, 875, 877, 879, 881, 883, 885, 886, 888, 890, 892, 894, 896, 897, 899, 901, 903, 904, 906, 908, 909, 911, 913, 914, 916, 918, 919, 921, 922, 924, 926, 927, 929, 930, 932, 933, 935, 936, 937, 939, 940, 942, 943, 944, 946, 947, 948, 950, 951, 952, 953, 955, 956, 957, 958, 959, 961, 962, 963, 964, 965, 966, 967, 968, 969, 970, 971, 972, 973, 974, 975, 976, 977, 978, 979, 979, 980, 981, 982, 983, 983, 984, 985, 986, 986, 987, 988, 988, 989, 989, 990, 991, 991, 992, 992, 993, 993, 994, 994, 995, 995, 995, 996, 996, 997, 997, 997, 997, 998, 998, 998, 999, 999, 999, 999, 999, 999, 1000, 1000, 1000, 1000, 1000, 1000, 1000};
#endif

/**
    *    @brief: Hàm thực hiện tính fft giải thuật radix-2 phương pháp lặp đệ quy
    *    @param: Re - con trỏ đến mảng dữ liệu Re
    *                 Im - con trỏ đến mảng dữ liệu Im
    */
inline void fft_radix_2_recursive_exec(int32_t *Re, int32_t *Im, uint16_t N_sample) {
    if(N_sample >= 2) {
        N_sample >>= 1;

        /* Tính fft của mỗi nửa mẫu dữ liệu*/
        fft_radix_2_recursive_exec(Re, Im, N_sample);
        fft_radix_2_recursive_exec(Re + N_sample, Im + N_sample, N_sample);

        int32_t Re_val = 0, Im_val = 0;
        int32_t Re_WOk = 0, Im_WOk = 0;
        int32_t sin_val = 0, cos_val = 0;

        for(uint16_t _k = 0; _k < N_sample; _k++)
        {
            // cos = k*(FFT_N_SAMPLE/4)/N_sample
            // sin = -cos(k*(FFT_N_SAMPLE/4)/N_sample + (FFT_N_SAMPLE/8))
            cos_val = cos_sin_table[(_k * (FFT_N_SAMPLE/4)) / N_sample];
            sin_val = cos_sin_table[((_k * (FFT_N_SAMPLE/4)) / N_sample) + (FFT_N_SAMPLE/8)];

            // Tam luu Ok
            Re_val = Re[_k + N_sample];
            Im_val = Im[_k + N_sample];

            // Re_WOk_Part = Re_W * Re_Ok - Im_W * Im_Ok
            Re_WOk = (cos_val * Re_val - sin_val * Im_val) / FFT_SINCOS_SCALE;
            // Im_WOk_Part = Re_W * Im_Ok + Im_W * Re_Ok
            Im_WOk = (cos_val * Im_val + sin_val * Re_val) / FFT_SINCOS_SCALE;

            /* Tạm lưu Ek */
            Re_val = Re[_k];
            Im_val = Im[_k];

//            if(max_val < Re[_k] + Re_WOk) max_val = Re[_k] + Re_WOk;
//            if(min_val > Re[_k] + Re_WOk) min_val = Re[_k] + Re_WOk;

            /* Re_X[k] = Re_Ek + Re_WOk */
            Re[_k] += Re_WOk;
            /* Im_X[k] = Im_Ek + Im_WOk */
            Im[_k] += Im_WOk;
            if(N_sample != (FFT_N_SAMPLE/2)) {
                /* Re_X[k+N] = Re_Ek - Re_WOk */
                Re[_k + N_sample] = Re_val - Re_WOk;
                /* Im_X[k+N] = Im_Ek - Im_WOk */
                Im[_k + N_sample] = Im_val - Im_WOk;
            }
        }
    }
}

/**
    *    @brief: Tính fft giải thuật radix-2 phương pháp vòng lặp for
    *    @param: Re - con trỏ đến mảng dữ liệu Re
    *                 Im - con trỏ đến mảng dữ liệu Im
    */
inline void fft_radix_2_normloop_execs(int32_t *Re, int32_t *Im, uint16_t N_sample) {


}
